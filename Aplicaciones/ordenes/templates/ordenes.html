{% extends "plantilla.html" %}
{% load static %}
{% block title %}Lista de Órdenes{% endblock %}
{% block content %}

<style>
    .form-header, .h2 {
        background-color: #0F0CE1;
        color: white;
        padding: 10px;
        border-radius: 5px;
    }
    .btn-link {
        padding: 0;
        border: none;
        background: none;
    }
    .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.2s;
        margin-bottom: 20px;
    }
    .card:hover {
        transform: scale(1.05);
    }
    .card-body p {
        margin: 0;
    }
    .card-footer {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background-color: #f8f9fa;
        border-top: 1px solid #ddd;
    }
    .description-container {
        display: none;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ddd;
    }
    .show-more-btn {
        cursor: pointer;
        color: #0F0CE1;
        border: none;
        background: none;
        text-decoration: underline;
    }
</style>

<div class="container">
    <div class="row my-3">
        <div class="col-md-12">
            <h2 class="h2">Lista de Órdenes</h2>
        </div>
        <div class="col-md-12 mb-3">
            <a href="{% url 'agOrden' %}" class="btn btn-primary">Agregar Orden</a>
            <a href="{% url 'calendario' %}" class="btn btn-primary">Abrir Calendario</a>
        </div>
    </div>

    <div class="row">
        {% for orden in ordenes %}
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        Orden Nº {{ orden.id_ord }} - {{ orden.fecha_ord|date:"d M Y" }}
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>Descripción:</strong>
                        {% if orden.descripcion_ord|length > 50 %}
                            <span id="short-description-{{ orden.id_ord }}">{{ orden.descripcion_ord|slice:":50" }}...</span>
                            <button class="show-more-btn" id="toggle-btn-{{ orden.id_ord }}" onclick="toggleDescription('{{ orden.id_ord }}')">Ver más</button>
                        {% else %}
                            <span>{{ orden.descripcion_ord }}</span>
                        {% endif %}
                    </p>
                    {% if orden.descripcion_ord|length > 50 %}
                        <div id="description-container-{{ orden.id_ord }}" class="description-container">
                            <p>{{ orden.descripcion_ord }}</p>
                            <button class="show-more-btn" onclick="toggleDescription('{{ orden.id_ord }}')">Ver menos</button>
                        </div>
                    {% endif %}
                    <p><strong>Bicicleta:</strong> {{ orden.bicicleta.color_bic }} {{ orden.bicicleta.tipo_bic }} {{'Cod:' }}{{ orden.bicicleta.id_bic }}</p>
                    <p><strong>Descripcion Bicicleta:</strong> {{ orden.bicicleta.descripcion_bic }} </p>
                    <p><strong>Mecánico:</strong> {{ orden.fkusuario.nombre }} {{ orden.fkusuario.apellido }}</p>
                    <p><strong>Dueño:</strong> {{ orden.bicicleta.cliente.nombre_cli }}</p>
                    <p><strong>Estado del Detalle:</strong></p>
                    <ul>
                        {% for detalle in orden.detalles %}
                            <li>{{ detalle.estado_det }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="card-footer">
                    <a href="/editarOrden/{{ orden.id_ord }}" class="btn btn-info icon-btn" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="/editarDetalle/{{ orden.id_ord }}" class="btn btn-warning icon-btn" title="Detalles">
                        <i class="fas fa-list"></i>
                    </a>
                    <a href="{% url 'detalle_orden' orden.id_ord %}" class="btn " title="Reporte Completo">
                        <i class="fas fa-print"></i>
                    </a>
                    <button class="btn btn-danger icon-btn" title="Eliminar" onclick="eliminarOrden('/eliminarOrden/{{ orden.id_ord }}');">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script type="text/javascript">
    function eliminarOrden(url) {
        Swal.fire({
            title: "¿Está seguro de eliminar la orden seleccionada?",
            text: "",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "SÍ"
        }).then((result) => {
            if (result.isConfirmed) {
                eliminarOrdenConfirmado(url);
            } else {
                console.log("Eliminación cancelada");
            }
        });
    }

    function eliminarOrdenConfirmado(url) {
        window.location.href = url;
    }

    function toggleDescription(id) {
        var shortDescription = document.getElementById('short-description-' + id);
        var container = document.getElementById('description-container-' + id);
        var btn = document.getElementById('toggle-btn-' + id);

        if (container.style.display === 'none') {
            container.style.display = 'block';
            shortDescription.style.display = 'none';
            btn.textContent = 'Ver menos';
        } else {
            container.style.display = 'none';
            shortDescription.style.display = 'inline';
            btn.textContent = 'Ver más';
        }
    }
</script>

{% endblock %}

{% extends "./plantilla2.html" %}
{% load static %}
{% block contenido %}<br><br>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.14/css/bootstrap-select.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.14/js/bootstrap-select.min.js"></script>
</head>

<style>
    .product-title {
        font-size: 1.rem;
        font-weight: bold;
        text-align: center;
    }
    .product-price, .product-category {
        text-align: center;
    }
    .card-body {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
    }
    .card-footer {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .btn-ver-mas {
        width: 100%;
    }

</style>

<div class="container">
    <div class="row">
        <div class="col-md-12 mb-6">
            <label for="selectCategoria">Seleccionar Categoría:</label>
            <select id="selectCategoria" class="form-select selectpicker" data-live-search="true">
                <option value="">Todas las Categorías</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.tipo_cat }}">{{ categoria.tipo_cat }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div><br>

<div class="container">
    <div class="row" id="productosContainer">
        {% for producto in productos %}
        <div class="col-lg-3 col-md-6 mb-4 producto" data-categoria="{{ producto.fkcategoria.tipo_cat }}">
            <div class="card h-100">
                {% if producto.ftprodu %}
                <img src="{{ producto.ftprodu.url }}" class="card-img-top" alt="{{ producto.nombre_pro }}" data-id="{{ producto.id_pro }}">
                {% else %}
                <img src="{% static 'default.jpg' %}" class="card-img-top" alt="Sin foto" data-id="{{ producto.id_pro }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title product-title">{{ producto.nombre_pro }}</h5>
                    <p class="card-text product-price"><strong>Precio:</strong> {{ producto.cantidad_pro }}{{ '$' }}
                    <p class="card-text product-category"><strong>Categoría:</strong> {{ producto.fkcategoria.tipo_cat }}</p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary btn-ver-mas" data-id="{{ producto.id_pro }}">Ver más</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para mostrar detalles del producto -->
<div class="modal fade" id="productoModal" tabindex="-1" role="dialog" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productoModalLabel">Detalles del Producto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <img id="modalImagen" class="img-fluid" src="" alt="Producto">
                <h5 id="modalNombre" class="mt-3"></h5>
                <p id="modalCategoria"></p>
                <p id="modalPrecio"></p>
                <p id="modalDescripcion"></p>
            </div>
            <div class="modal-footer">

                <a href="productos" class="btn btn-danger">Cerrar</a>
                <a id="whatsappLink" class="btn btn-success" target="_blank">Contactar por WhatsApp</a>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $('.selectpicker').selectpicker();

        // Filtrar productos por categoría
        $('#selectCategoria').change(function() {
            var selectedCategoria = $(this).val();
            if (selectedCategoria === '') {
                $('.producto').show();
            } else {
                $('.producto').hide();
                $('.producto[data-categoria="' + selectedCategoria + '"]').show();
            }
        });

        // Mostrar información del producto en el modal
        $('.btn-ver-mas').on('click', function() {
            var productoId = $(this).data('id');

            // Realizar una solicitud AJAX para obtener la información del producto
            $.ajax({
                url: '/obtenerProducto/' + productoId + '/',
                method: 'GET',
                success: function(data) {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        $('#modalImagen').attr('src', data.ftprodu ? data.ftprodu : '{% static "default.jpg" %}');
                        $('#modalNombre').text(data.nombre_pro);
                        $('#modalCategoria').text('Categoría: ' + data.fkcategoria);
                        $('#modalPrecio').text('Precio: ' + data.cantidad_pro );
                        $('#modalDescripcion').text(data.descripcion_pro);

                        // Generar enlace de WhatsApp
                        var whatsappMessage = `Hola, estoy interesado en el producto ${data.nombre_pro} de la categoría ${data.fkcategoria} con un precio de ${data.cantidad_pro}  $`;
                        var whatsappUrl = `https://wa.me/593960611425?text=${encodeURIComponent(whatsappMessage)}`;
                        $('#whatsappLink').attr('href', whatsappUrl);

                        // Mostrar el modal
                        $('#productoModal').modal('show');
                    }
                },
                error: function(error) {
                    console.log(error);
                }
            });
        });
    });
</script>

  {% endblock %}
